name: Create Tag

on:
  workflow_dispatch:
    inputs:
      project:
        type: choice
        description: "Project to create a tag for"
        required: true
        options:
          - "app1"
          - "app2"
      bumpType:
        type: choice
        description: "Type of tag version bump (major, minor, patch)"
        required: true
        default: patch
        options:
          - "major"
          - "minor"
          - "patch"
concurrency:
  group: tag-${{ inputs.project }}
  cancel-in-progress: false

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all tags
        run: git fetch --tags --quiet

      - name: Get latest Tag
        id: latest-tag
        run: |
          previous_tag=$(git tag | grep -E '^${{inputs.project}}/v[0-9]+\.[0-9]+\.[0-9]+$' | sort --version-sort --reverse | head -n 1)
          if [ "$previous_tag" == "" ]; then
            previous_tag=${{inputs.project}}/v0.0.0
          fi
          echo "previous_tag=$previous_tag" >> $GITHUB_OUTPUT

      - name: Print previous tag
        run: echo ${{steps.latest-tag.outputs.previous_tag}}

      - name: Generate new tag version
        id: generate-new-tag-version
        run: |
          previous_version=${{steps.latest-tag.outputs.previous_tag}}
          sem_ver=$(echo $previous_version | cut -d '/' -f2 | cut -d 'v' -f2)

          major_version=$(echo $sem_ver | cut -d '.' -f1)
          minor_version=$(echo $sem_ver | cut -d '.' -f2)
          patch_version=$(echo $sem_ver | cut -d '.' -f3)

          if [ ${{ inputs.bumpType }} == "major" ]; then
            major_version=$((major_version + 1))
            minor_version=0
            patch_version=0
            echo "Updating major version: $major_version.$minor_version.$patch_version"
          elif [ ${{ inputs.bumpType }} == "minor" ]; then
            minor_version=$((minor_version + 1))
            patch_version=0
            echo "Updating minor version: $major_version.$minor_version.$patch_version"
          elif [ ${{ inputs.bumpType }} == "patch" ]; then
            patch_version=$((patch_version + 1))
            echo "Updating patch version: $major_version.$minor_version.$patch_version"
          fi

          new_version="$major_version.$minor_version.$patch_version"
          new_tag=${{inputs.project}}/v$new_version
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          echo "New tag: $new_tag"

      - name: Check if tag already exists
        run: |
          new_tag=${{steps.generate-new-tag-version.outputs.new_tag}}
          if git rev-parse "$new_tag" >/dev/null 2>&1; then
            echo "::error::Tag $new_tag already exists. If you need to recreate it, delete the existing tag first:"
            echo "::error::  git tag -d $new_tag"
            echo "::error::  git push origin :refs/tags/$new_tag"
            echo "::error::Or use a different bump type to create a newer version."
            exit 1
          fi
          echo "::notice::Tag $new_tag does not exist, proceeding with creation"

      - name: Tag commit with new version
        id: create-tag
        run: |
          new_tag=${{steps.generate-new-tag-version.outputs.new_tag}}
          git tag -a "$new_tag" -m "Release $new_tag"
          git push origin "$new_tag"
          echo "::notice::Successfully created tag: $new_tag"

      - name: Create workflow summary
        run: |
          echo "## Tag Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Project** | \`${{inputs.project}}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Previous Tag** | \`${{steps.latest-tag.outputs.previous_tag}}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **New Tag** | \`${{steps.create-tag.outputs.tag}}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Bump Type** | \`${{inputs.bumpType}}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Created By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
